#!/bin/bash

reflectorName "Direct Tar Compression Backup"
reflectorId   "bktools_backup_c_directtar"

registerBackupModule directtar

function reflect() {
  logt "Hello."
  local devicepath="$1"
  local tarfile="$2"
  local resultcode=0
  runall adb_interface func adb_root
  if [ $? -eq 0 ]; then
    sleep 0.2
    adb_shell mkdir -p /tmp/backuptools/
    adb_shell mkfifo /tmp/backuptools/bk.pipe
    sleep 0.4
    adb_execout "tar -cvap $devicepath 2>/tmp/backuptools/bk.pipe">$tarfile &
    local execout_pid=$!
    adb_shell cat /bk.pipe &
    local bkpipe_pid=$!
    wait $execout_pid
    kill -9 $bkpipe_pid
    sleep 0.2
    adb_shell rm -f /tmp/backuptools/bk.pipe
    echo -e "\n${CL_GREEN}Backup completed${CL_RESET}\n"
  fi
  return $resultcode
}
